<div id=result></div>
<style>span {cursor:pointer}</style>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  const assets = 'http://simnet.ward.asia.wiki.org/assets/pages'
  const params = Object.fromEntries(new URLSearchParams(location.search).entries())
  const nodes = await fetch(`${assets}/next-hop-routing/data.json`).then(res => res.json())

  const pretty = node => JSON.stringify(node,null,2)
    .replace(/(,|\[)[\r\n\s]*(\d)/g,"$1$2")
    .replace(/(\d)[\r\n\s]*\]/g,"$1]")
  const log = arg => {console.log(arg); return arg}
  const node = zip => nodes.find(node => node.zip == zip)
  const hops = node => node.path
    .map(zip => nodes.find(node => node.zip == zip))
    .map(log)
  const markers = nodes => nodes
    .map(node => `${node.lat}, ${node.lon} ${node.city}`)
    .join("\n")
  // const latlon = node => [node.lat, node.lon]
  const point = (here,there) => {
    const dy = (there.lat-here.lat)*69
    const dx = (there.lon-here.lon)*48
    console.log({dx,dy})
    return (Math.abs(dy)>Math.abs(dx)) ?
      (dy > 0 ? 'N' : 'S') :
      (dx > 0 ? 'E' : 'W')
  }

  const picks = (nodes) => nodes
    .sort((a,b) => a.city - b.city)
    .map(there => `
      ${params['zip'] ? point(node(params['zip']),there):''}
      <span onclick=docity(event)>${there.city}</span>
    `)
    .join('<br>')

  console.log(nodes)
  if('zip' in params)
    window.result.innerHTML = picks(hops(node(params.zip)))
  else
    window.result.innerHTML = picks(nodes)

  window.docity = event => {
    const target = event.target
    const node = nodes.find(node => node.city == target.innerText)
    const title = `${node.city} Node`
    const story = []
    story.push({type:'paragraph',text:`Population ${node.pop}, Zip ${node.zip}, Links ${node.path.length}`})
    story.push({type:'frame',text:`${assets}/analysis-tools/node.html?zip=${node.zip}`})
    story.push({type:'paragraph',text:`See Lineup as [[Street Map]]`})
    story.push({type:'map',text:`${node.lat}, ${node.lon} ${node.city}`})
    // story.push({type:'markdown',text:hops(node).map(there => `${point(latlon(node),latlon(there))} to ${there.city}`).join("\n")})
    // story.push({type:'paragraph',text:`See Lineup as [[Street Map]]`})
    story.push({type:'map',text:markers(hops(node))})
    story.push({type:'code',text:pretty(node)})
    console.log(story)
    frame.open({title,story},event.shiftKey)
  }
</script>